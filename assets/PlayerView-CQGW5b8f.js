import{Q as O,a4 as U,A as W,j as e,M as G,r as l,a2 as X,X as q,c as k,Z as J,ah as Y,ad as Z}from"./vendor-B95B9ZTO.js";import{e as ee,i as te,g as H,f as re,s as ne,b as B,d as ae,c as se,M as ie,E as v,h as N,I as P,a as C,P as I,B as E,j as K,L as V,k as z,u as ce,l as oe,m as de,n as le,o as M,p as ue,q as D,r as me,t as $,v as L,w as pe,x as xe,y as he,z as fe,A as ge,C as ye,D as je,F as we,G as Se,H as be,J as Ee,K as ve,O as Ne,Q as Pe,R,S as Ce}from"./index-DIVXyTVb.js";import{a as b,I as F}from"./Icons-yUTtIW30.js";import{a as _,h as Ie}from"./react-dom-BKLNrvNX.js";import"./auth-72H9TcpW.js";import"./caption-parsing-DkYi0hfG.js";import"./locales-DcUbfxfW.js";import"./hls-C_AVPmGC.js";import"./language-db-BnRLPJUA.js";function Ae(r,t){return!!z().DISALLOWED_IDS.map(a=>a.split("-")).find(a=>r===a[1]&&t===a[0])}function Me(r){const{t}=O(),i=U(),a=W(),{error:u,value:f,loading:m}=_(async()=>{var s;const h=await ee(),x=(h==null?void 0:h.success)&&te(h.version)&&h.allowed;if(x&&!h.hasPermission)throw new Error("extension-no-permission");const y=H();if(y&&!x)try{await re(y)}catch{throw new Error("failed-api-metadata")}else ne([...B().listSources(),...B().listEmbeds()]);let p=null;try{if(!i.media)throw new Error("no media params");p=ae(i.media)}catch{}if(!p)return null;if(Ae(p.id,p.type))throw new Error("dmca");let g=null;try{g=await se(p.type,p.id,i.season)}catch(n){if(n.status===404)return null;throw n}if(!g)return null;let w=i.episode;if(g.meta.type===ie.SERIES){let n=g.meta.seasonData.episodes.find(c=>c.id===i.episode);n||(n=g.meta.seasonData.episodes[0]),w=n.id,(i.season!==g.meta.seasonData.id||i.episode!==n.id)&&a(`/media/${i.media}/${g.meta.seasonData.id}/${n.id}`,{replace:!0})}(s=r.onGetMeta)==null||s.call(r,g,w)},[]);return u&&u.message==="extension-no-permission"?e.jsx(v,{children:e.jsxs(N,{children:[e.jsx(P,{icon:b.WAND,children:t("player.metadata.extensionPermission.badge")}),e.jsx(C,{children:t("player.metadata.extensionPermission.title")}),e.jsx(I,{children:t("player.metadata.extensionPermission.text")}),e.jsx(E,{onClick:()=>{K({page:"PermissionGrant",redirectUrl:window.location.href})},theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.metadata.extensionPermission.button")})]})}):u&&u.message==="dmca"?e.jsx(v,{children:e.jsxs(N,{children:[e.jsx(P,{icon:b.DRAGON,children:t("player.metadata.dmca.badge")}),e.jsx(C,{children:t("player.metadata.dmca.title")}),e.jsx(I,{children:t("player.metadata.dmca.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.metadata.failed.homeButton")})]})}):u&&u.message==="failed-api-metadata"?e.jsx(v,{children:e.jsxs(N,{children:[e.jsx(P,{icon:b.WAND,children:t("player.metadata.failed.badge")}),e.jsx(C,{children:t("player.metadata.api.text")}),e.jsx(I,{children:t("player.metadata.api.title")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.metadata.failed.homeButton")})]})}):u?e.jsx(v,{children:e.jsxs(N,{children:[e.jsx(P,{icon:b.WAND,children:t("player.metadata.failed.badge")}),e.jsx(C,{children:t("player.metadata.failed.title")}),e.jsx(I,{children:t("player.metadata.failed.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.metadata.failed.homeButton")})]})}):!f&&!m?e.jsx(v,{children:e.jsxs(N,{children:[e.jsx(P,{icon:b.WAND,children:t("player.metadata.notFound.badge")}),e.jsx(C,{children:t("player.metadata.notFound.title")}),e.jsx(I,{children:t("player.metadata.notFound.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.metadata.notFound.homeButton")})]})}):e.jsx(v,{children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(V,{})})})}function Re(r){const{t}=O(),i=ce("error"),a=G(),[u,f]=l.useState("unknown"),m=l.useMemo(()=>{const h=r.data;let x="";const y=oe();return x+=`URL - ${a.pathname}
`,x+=`API - ${y.length>0}

`,Object.values(h.sources).forEach(p=>{var g;x+=`${p.id}: ${p.status}
`,p.reason&&(x+=`${p.reason}
`),(g=p.error)!=null&&g.message?x+=`${p.error.name??"unknown"}: ${p.error.message}
`:p.error&&(x+=`${p.error.toString()}
`)}),x},[r,a]);return l.useEffect(()=>{de().then(h=>{f(h)})},[t]),u==="disallowed"?e.jsx(v,{children:e.jsxs(N,{children:[e.jsx(P,{icon:b.LOCK,children:t("player.scraping.extensionFailure.badge")}),e.jsx(C,{children:t("player.scraping.extensionFailure.title")}),e.jsx(I,{children:e.jsx(X,{i18nKey:"player.scraping.extensionFailure.text",components:{bold:e.jsx("span",{className:"font-bold",style:{color:"#cfcfcf"}})}})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(E,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.scraping.extensionFailure.homeButton")}),e.jsx(E,{onClick:()=>{K({page:"PermissionGrant",redirectUrl:window.location.href})},theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.scraping.extensionFailure.enableExtension")})]})]})}):e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(P,{icon:b.WAND,children:t("player.scraping.notFound.badge")}),e.jsx(C,{children:t("player.scraping.notFound.title")}),e.jsx(I,{children:t("player.scraping.notFound.text")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(E,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.scraping.notFound.homeButton")}),e.jsx(E,{onClick:()=>i.show(),theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:t("player.scraping.notFound.detailsButton")})]})]}),m?e.jsx(le,{id:i.id,onClose:()=>i.hide(),error:m}):null]})}function T(r){return r.type==="loading"}function ke(r){const[t]=q(()=>({percentage:T(r)?r.percentage:0}),[r]);return e.jsxs("div",{className:k({"p-0.5 border-current border-[3px] rounded-full h-6 w-6 relative transition-colors":!0,"text-video-scraping-loading":r.type==="loading","text-video-scraping-noresult text-opacity-50":r.type==="waiting","text-video-scraping-error bg-video-scraping-error":r.type==="error","text-green-500 bg-green-500":r.type==="success","text-video-scraping-noresult bg-video-scraping-noresult":r.type==="noresult"},r.className),children:[e.jsx(M,{animation:"fade",show:T(r),children:e.jsx("svg",{width:"100%",height:"100%",viewBox:"0 0 64 64",xmlns:"http://www.w3.org/2000/svg",className:"rounded-full -rotate-90",children:e.jsx(J.circle,{strokeWidth:"32",strokeDasharray:Y(t.percentage,i=>`${i} 100`),r:"25%",cx:"50%",cy:"50%",fill:"transparent",stroke:"currentColor",className:"transition-[strokeDasharray]"})})}),e.jsx(M,{animation:"fade",show:r.type==="error",children:e.jsx(F,{className:"absolute inset-0 flex items-center justify-center text-background-main",icon:b.X})}),e.jsx(M,{animation:"fade",show:r.type==="success",children:e.jsx(F,{className:"absolute inset-0 flex items-center text-sm justify-center text-background-main",icon:b.CHECKMARK})}),e.jsx(M,{animation:"fade",show:r.type==="noresult",children:e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"h-[3px] flex-1 mx-1 rounded-full bg-background-main"})})})]})}const Oe={notfound:"player.scraping.items.notFound",failure:"player.scraping.items.failure",pending:"player.scraping.items.pending"},De={failure:"error",notfound:"noresult",pending:"loading",success:"success",waiting:"waiting"};function Q(r){const{t}=O(),i=Oe[r.status],a=De[r.status];return e.jsxs("div",{className:"grid gap-4 grid-cols-[auto,1fr]","data-source-id":r.id,children:[e.jsx(ke,{type:a,percentage:r.percentage??0}),e.jsxs("div",{children:[e.jsx("p",{className:a==="loading"?"text-white":"text-type-secondary",children:r.name}),e.jsx(M,{animation:"fade",show:!!i,children:e.jsx("p",{className:"text-[15px] mt-1",children:i?t(i):""})}),r.children]})]})}function Be(r){return e.jsx("div",{"data-source-id":r.id,className:"w-80 mb-6",children:e.jsx("div",{className:k({"!bg-opacity-100 py-6":r.hasChildren,"w-80 rounded-md px-6 bg-video-scraping-card bg-opacity-0":!0}),children:e.jsx(Q,{...r})})})}function Fe(){const[r,t]=l.useState({}),[i,a]=l.useState([]),[u,f]=l.useState(),m=l.useRef(null),h=l.useCallback(s=>{t(s.sourceIds.map(n=>{const c=L().find(d=>d.id===n);if(!c)throw new Error("invalid source id");return{name:c.name,id:c.id,status:"waiting",percentage:0}}).reduce((n,c)=>(n[c.id]=c,n),{})),a(s.sourceIds.map(n=>({id:n,children:[]})))},[]),x=l.useCallback(s=>{const n=m.current;t(c=>(c[s]&&(c[s].status="pending"),n&&c[n]&&c[n].status==="pending"&&(c[n].status="success"),{...c})),f(s),m.current=s},[]),y=l.useCallback(s=>{t(n=>(n[s.id]&&(n[s.id].status=s.status,n[s.id].reason=s.reason,n[s.id].error=s.error,n[s.id].percentage=s.percentage),{...n}))},[]),p=l.useCallback(s=>{t(n=>(s.embeds.forEach(c=>{const o=L().find(j=>j.id===c.embedScraperId);if(!o)throw new Error("invalid source id");const d={embedId:c.embedScraperId,name:o.name,id:c.id,status:"waiting",percentage:0};n[c.id]=d}),{...n})),a(n=>{const c=n.find(o=>o.id===s.sourceId);if(!c)throw new Error("invalid source id");return c.children=s.embeds.map(o=>o.id),[...n]})},[]),g=l.useCallback(()=>{m.current=null},[]),w=l.useCallback(s=>(s&&m.current&&t(n=>m.current?(n[m.current]&&(n[m.current].status="success"),{...n}):n),s),[]);return{initEvent:h,startEvent:x,updateEvent:y,discoverEmbedsEvent:p,startScrape:g,getResult:w,sources:r,sourceOrder:i,currentSource:u}}function $e(){const{sources:r,sourceOrder:t,currentSource:i,updateEvent:a,discoverEmbedsEvent:u,initEvent:f,getResult:m,startEvent:h,startScrape:x}=Fe(),y=ue(g=>g.sourceOrder);return{startScraping:l.useCallback(async g=>{const w=H();if(w&&!D()){x();const c=pe(w),o=await me(c.scrapeAll(g),["completed","noOutput"]);o.on("init",f),o.on("start",h),o.on("update",a),o.on("discoverEmbeds",u);const d=await o.promise();return d&&D()&&await $(d.stream),m(d===""?null:d)}x();const n=await B().runAll({media:g,sourceOrder:y,events:{init:f,start:h,update:a,discoverEmbeds:u}});return n&&D()&&await $(n.stream),m(n)},[f,h,a,u,m,x,y]),sourceOrder:t,sources:r,currentSource:i}}function Le(r,t,i,a){const[u,f]=l.useState(!1),m=l.useCallback(()=>{if(!r.current||!t.current)return;const x=[...t.current.querySelectorAll("div[data-source-id]")],y=x.findIndex(A=>A.getAttribute("data-source-id")===a),p=x[y];if(!p)return;const g=r.current.getBoundingClientRect().width,w=t.current.getBoundingClientRect().width,s=r.current.getBoundingClientRect().height,n=t.current.getBoundingClientRect().top,c=p.getBoundingClientRect().top,o=p.getBoundingClientRect().height,d=c-n,j=g/2-w/2,S=s/2-d-o/2;t.current.style.transform=`translateY(${S}px) translateX(${j}px)`,setTimeout(()=>{f(!0)},150)},[a,r,t,f]),h=l.useRef(m);return l.useEffect(()=>{m(),h.current=m},[m,i]),l.useEffect(()=>{function x(){h.current()}return window.addEventListener("resize",x),()=>{window.removeEventListener("resize",x)}},[]),u}function Te(r){return e.jsxs("div",{className:"flex flex-col justify-center items-center h-screen text-center font-medium",children:[e.jsx(xe,{}),e.jsx(F,{className:"text-type-danger text-2xl",icon:b.WARNING}),e.jsx("div",{className:"max-w-[19rem] mt-3 mb-12 text-type-secondary",children:r.children})]})}function Ue(r){const{report:t}=he(),{startScraping:i,sourceOrder:a,sources:u,currentSource:f}=$e(),m=Ie(),{t:h}=O(),x=l.useRef(null),y=l.useRef(null),[p,g]=l.useState(!1),w=Le(x,y,a,f),s=l.useRef({sourceOrder:a,sources:u});l.useEffect(()=>{s.current={sourceOrder:a,sources:u}},[a,u]);const n=l.useRef(!1);l.useEffect(()=>{n.current||(n.current=!0,(async()=>{var d,j;const o=await i(r.media);m()&&((d=r.onResult)==null||d.call(r,s.current.sources,s.current.sourceOrder),t(fe(r.media,s.current.sourceOrder,s.current.sources)),(j=r.onGetStream)==null||j.call(r,o))})().catch(()=>g(!0)))},[i,r,t,m]);let c=a.findIndex(o=>o.id===f||o.children.includes(f??""));return c===-1&&(c=a.length-1),p?e.jsx(Te,{children:h("player.turnstile.error")}):e.jsxs("div",{className:"h-full w-full relative dir-neutral:origin-top-left flex",ref:x,children:[!a||a.length===0?e.jsxs("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-center flex flex-col justify-center z-0",children:[e.jsx(V,{className:"mb-8"}),e.jsx("p",{children:h("player.turnstile.verifyingHumanity")})]}):null,e.jsx("div",{className:k({"absolute transition-[transform,opacity] opacity-0 dir-neutral:left-0":!0,"!opacity-100":w}),ref:y,children:a.map(o=>{const d=u[o.id],j=Math.abs(a.findIndex(S=>S.id===o.id)-c);return e.jsx("div",{className:"transition-opacity duration-100",style:{opacity:Math.max(0,1-j*.3)},children:e.jsx(Be,{id:o.id,name:d.name,status:d.status,hasChildren:o.children.length>0,percentage:d.percentage,children:e.jsx("div",{className:k({"space-y-6 mt-8":o.children.length>0}),children:o.children.map(S=>{const A=u[S];return e.jsx(Q,{id:S,name:A.name,status:A.status,percentage:A.percentage},S)})})})},o.id)})})]})}async function We(){return!(!z().HAS_ONBOARDING||await ge()||ye.getState().proxySet||je.getState().completed)}function Ge(r){const t=r??"";if(!!!t.match(/^\d+(:\d+)*$/))return null;const a=t.split(":").map(Number).reverse(),u=a[2]??0,f=Math.min(a[1]??0,59),m=Math.min(a[0]??0,f>0?59:1/0);return u*60*60+f*60+m}function He(){const r=W(),t=U(),[i,a]=l.useState(null),[u]=we("t"),{status:f,playMedia:m,reset:h,setScrapeNotFound:x,shouldStartFromBeginning:y,setShouldStartFromBeginning:p}=Se(),{setPlayerMeta:g,scrapeMedia:w}=be(),s=Ee(),n=JSON.stringify({media:t.media,season:t.season,episode:t.episode});l.useEffect(()=>{h()},[n,h]);const c=l.useCallback(d=>{var j,S;(d==null?void 0:d.type)==="show"?r(`/media/${t.media}/${(j=d.season)==null?void 0:j.tmdbId}/${(S=d.episode)==null?void 0:S.tmdbId}`):r(`/media/${t.media}`)},[r,t]),o=l.useCallback(d=>{if(!d)return;let j;u&&(j=Ge(u)??void 0),m(ve(d),Ne(d.stream.captions),d.sourceId,y?0:j),p(!1)},[m,u,y,p]);return e.jsxs(Pe,{backUrl:s,onMetaChange:c,children:[f===R.IDLE?e.jsx(Me,{onGetMeta:g}):null,f===R.SCRAPING&&w?e.jsx(Ue,{media:w,onResult:(d,j)=>{a({sourceOrder:j,sources:d}),x()},onGetStream:o}):null,f===R.SCRAPE_NOT_FOUND&&i?e.jsx(Re,{data:i}):null,f===R.PLAYBACK_ERROR?e.jsx(Ce,{}):null]})}function Ze(){const r=G(),{loading:t,error:i,value:a}=_(()=>We());if(i)throw new Error("Failed to detect onboarding");return t?null:a?e.jsx(Z,{replace:!0,to:{pathname:"/onboarding",search:`redirect=${encodeURIComponent(r.pathname)}`}}):e.jsx(He,{})}export{Ze as PlayerView,He as RealPlayerView,Ze as default};
//# sourceMappingURL=PlayerView-CQGW5b8f.js.map
